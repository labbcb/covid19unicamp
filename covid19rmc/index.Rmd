---
title: "COVID-19 Tracker: Região Metropolitana de Campinas + Limeira + Piracicaba"
output: 
  flexdashboard::flex_dashboard:
    logo: logo_transparent_background.png
    orientation: rows
    horizontal_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
```

```{r get_data, include=FALSE}
library(leaflet)
library(tidyverse)
library(datacovidbr)
library(geobr)
library(plotly)
library(xts)
library(dygraphs)
source("data_functions.R")
source("plot_functions.R")

RMC = tibble(city = c("Americana", "Artur Nogueira", "Campinas", "Cosmópolis", "Engenheiro Coelho",
                      "Holambra", "Hortolândia", "Indaiatuba", "Itatiba", "Jaguariúna",
                      "Monte Mor", "Morungaba", "Nova Odessa", "Paulínia", "Pedreira",
                      "Santa Bárbara D'oeste", "Santo Antônio De Posse", "Sumaré",
                      "Valinhos", "Vinhedo"),
             city_ibge_code= c(3501608, 3503802, 3509502, 3512803, 3515152,
                               3519055, 3519071, 3520509, 3523404, 3524709,
                               3531803, 3532009, 3533403, 3536505, 3537107,
                               3545803, 3548005, 3552403,
                               3556206, 3556701))

COI = tibble(city = c("Piracicaba", "Limeira"), city_ibge_code = c(3538709, 3526902))

SOI = tibble(city = "São Paulo", city_ibge_code=NA)

spdata = get_data("SP", RMC, COI, SOI)

# readxl::read_excel("~/Downloads/atlas2013_dadosbrutos_pt.xlsx", sheet=2) %>%
#   filter(ANO == 2010, UF == 35) %>% 
#   select(ANO:Município, IDHM)
## casos0 = (RMC %>% drop_na()) %>% anti_join(spdata, by='city_ibge_code')

dados_municipios = get_base_municipios("SP", 2018) %>% 
  semi_join(RMC %>% bind_rows(COI), by=c("code_muni"="city_ibge_code"))

# rmc_last = dados_municipios %>%
#   left_join(spdata %>%
#               filter(is_last) %>% 
#              select(-city, -place_type, -is_last), by=c("code_muni"="city_ibge_code"))
```


Panorama
==============================================


Painel de Controle {.sidebar}
-----------------------------------------------------------------------

```{r}
## vec eh essencial para que os graficos dinamicos funcionem
##     para um callback que identifique o nome da cidade
h3("Cidades / Regiões")
selectizeInput(
  'choice_city', label = "Escolha até 4 opções",
  choices = spdata %>% get_cities() %>% unlist(),
  selected = c("Campinas", "RMC"),
  multiple = TRUE,
  options = list(create=TRUE, maxItems=4,
                 placeholder='Selecione uma cidade/região')
)

# checkboxGroupInput("choice_city",
#                    h3("Cidades"),
#                    choices = spdata %>% get_cities(),
#                    selected = "RMC")
h3("Escala")
checkboxInput("log_10", "Logarítmica", FALSE)
```

Row
-----------------------------------------------------------------------

### Casos por 100 mil Habitantes

```{r}
renderLeaflet({
  dados_municipios %>%
    left_join(spdata %>% filter(place_type %in% c('city_coi', 'city_rmc'), is_last),
              by=c("code_muni"="city_ibge_code")) %>%
    mutate(cases100k = ifelse(is.na(cases100k), 0, cases100k)) %>% 
    create_dyn_map('cases100k')
})
```

Row
-----------------------------------------------------------------------

<!-- ### Taxa de Fatalidade: Campinas (Ref. OMS = 3.4%) -->

```{r, eval=FALSE}
getField = function(input, city="Campinas", field="CFR"){
  tmp = input %>% filter(name_muni == city)
  tmp[[field]]
}

gsec = gaugeSectors(success = c(0.00, 3.40),
                    warning = c(3.41, 4.99),
                    danger  = c(5.00, 100))
gauge(getField(rmc_last, "Campinas"), min=0, max=100, symbol="%", sectors = gsec)
```

### Casos Confirmados por 100mil Habitantes

```{r}
renderDygraph({
  plot_counts_time(spdata, "cases100k", input$choice_city, input$log_10)
})
```


> O número de casos, por 100 mil habitantes, de COVID-19 confirmados até a presente data.

### Óbitos por 100 mil Habitantes

```{r}
renderDygraph({
  plot_counts_time(spdata, "deaths100k", input$choice_city, input$log_10)
})
```

> O número de óbitos padronizado por 100 mil habitantes até a presente data.

### Letalidade (%)

```{r}
renderDygraph({
  plot_counts_time(spdata, "CFR", input$choice_city, input$log_10)
})
```

> A razão entre óbitos e casos confirmados até a presente data. A OMS, em março, indicou que, em média, 3,4% dos casos evoluem para óbito.

Contato
==============================================

### Implementação

>Força Tarefa UNICAMP Contra a COVID-19 (Frente de Modelagem e Epidemiologia)<br/><br/>
>[Biostatistics and Computational Biology Laboratory (BCBLab)](https://www.bcblab.org)<br/>
>Instituto de Matemática, Estatística e Computação Científica<br/>
>Universidade de Campinas / UNICAMP<br/>


Responsável Técnico: Prof. Dr. Benilton S Carvalho (benilton@unicamp.br)

Contribuições:

  - André Menezes
  - Gabriel Franco
  - Victor Freguglia
  - Welliton de Souza