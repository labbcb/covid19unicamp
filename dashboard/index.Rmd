---
title: "COVID-19"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: https://github.com/labbcb/covid19unicamp
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
source("data_functions.R")
source("plot_functions.R")

data <- load_data()
data_state <- get_data_state(data)
data_city <- get_data_city(data)
map_data <- calc_map_data(data)

if (file.exists("dados_municipios.rds")) {
  require(geobr)
  dados_municipios <- readRDS("dados_municipios.rds")
} else {
  dados_municipios = read_municipality(code_muni="SP", year=2018, showProgress = FALSE)
  saveRDS(dados_municipios, "dados_municipios.rds")
}
dyn_map_data = get_data_munic_from_state(data, "SP", dados_municipios)
```

Campinas {data-icon="fa-street-view"}
=====================================

Row
-------------------------------------

### Confirmados {.value-box}

```{r}
renderValueBox({
  valueBox(last(data_city$confirmed),
           icon = "fa-plus-square",
           color = "orange")
})
```

### Óbitos {.value-box}

```{r}
renderValueBox({
  valueBox(last(data_city$deaths),
           icon = "fa-procedures",
           color = "red")
})
```

Row
-------------------------------------

### Números acumulados de casos confirmados e mortes por data

```{r}
plot_cumulative_cases(data_city)
```

### Taxa de aumento em relação ao dia anterior

```{r}
plot_tax_increase(data_city)
```

Estado de Sao Paulo {data-icon="fa-city"}
=====================================

Row
-------------------------------------

### Confirmados {.value-box}

```{r}
renderValueBox({
  valueBox(last(data_state$confirmed),
           icon = "fa-plus-square",
           color = "orange")
})
```

### Óbitos {.value-box}

```{r}
renderValueBox({
  valueBox(last(data_state$deaths),
           icon = "fa-procedures",
           color = "red")
})
```

Row
-------------------------------------

### Números acumulados de casos confirmados e mortes por data

```{r}
plot_cumulative_cases(data_state)
```

### Taxa de aumento em relação ao dia anterior

```{r}
plot_tax_increase(data_state)
```

Brasil {data-icon="fa-globe-americas"}
=====================================

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
radioButtons(
  "mapBrChoice",
  "Métrica:",
  c(
    "Casos Confirmados" = "confirmed1m",
    "Óbitos" = "deaths1m",
    "CFR" = "CFR"
  )
)
```

Column
-----------------------------------------------------------------------

### Mapa

```{r}
renderPlot({
  plot_brazil_map(map_data, input$mapBrChoice)
})
```

Mapas (Fase: alpha) {data-icon="fa-map-marked-alt"}
=====================================

```{r}

get_pallete = function(this_var, scheme="RdYlBu", nbins=5, this_rev=TRUE){
  bins = quantile(na.omit(this_var),
                  seq(0, 1, length.out=nbins+1))
  colorBin(scheme, domain=this_var, bins=bins,
           reverse=this_rev, right=TRUE)  
}

get_labels = function(cities, values){
  values = round(values, 2)
  values = sprintf("%0.2f", values)
  values[values == "NA"] = "N/A"
  values = str_replace(values, "\\.", ",")
  sprintf("<strong>%s</strong><br/>%s casos / 100.000 habitantes", cities, values ) %>%
    lapply(htmltools::HTML)
}

pal = get_pallete(dyn_map_data$confirmed_per_100k_inhabitants)
labels = get_labels(dyn_map_data$name_muni, dyn_map_data$confirmed_per_100k_inhabitants)

leaflet(dyn_map_data) %>% 
  addTiles() %>% 
  addPolygons( fillColor = ~pal(confirmed_per_100k_inhabitants),
               weight = 2,
               opacity = 1,
               color = "white",
               dashArray = "3",
               fillOpacity = 0.7,
               highlight = highlightOptions(
                 weight = 5,
                 color = "#666",
                 dashArray = "",
                 fillOpacity = 0.7,
                 bringToFront = TRUE),
               label = labels,
               labelOptions = labelOptions(
                 style = list("font-weight" = "normal", padding = "3px 8px"),
                 textsize = "15px",
                 direction = "auto")) %>% 
  addLegend(pal = pal,
            values = ~confirmed_per_100k_inhabitants,
            labFormat = labelFormat(digits = 2, big.mark="."),
            opacity = 0.7,
            title = "",
            position = "bottomright")
```

